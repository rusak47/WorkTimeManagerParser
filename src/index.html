<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Tracker Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <style>
        .max-w-xs {
            max-width: 20rem;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .tag-color-0 { background-color: #FECACA; }
        .tag-color-1 { background-color: #FED7AA; }
        .tag-color-2 { background-color: #FEF08A; }
        .tag-color-3 { background-color: #D9F99D; }
        .tag-color-4 { background-color: #BFDBFE; }
        .tag-color-5 { background-color: #DDD6FE; }
        .tag-color-6 { background-color: #FBCFE8; }
        .tag-color-7 { background-color: #FDE68A; }
        .weekend-row {
            background-color: #FFF7ED;
            border-left: 4px solid #F97316;
        }
        .weekend-row:hover {
            background-color: #FFEDD5;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-clock mr-3 text-blue-500"></i>
                Time Tracker Dashboard
            </h1>
            <p class="text-gray-600 mt-2">Visualize how you spend your time across different activities</p>
        </header>

        <!-- Controls -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-8 fade-in">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Import JSON Data</label>
                    <div class="flex items-center gap-2">
                        <input type="file" id="jsonFile" accept=".json" class="hidden">
                        <button id="uploadBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md transition flex items-center">
                            <i class="fas fa-upload mr-2"></i> Choose File
                        </button>
                        <span id="fileName" class="text-gray-500 text-sm">No file selected</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Date Range</label>
                    <div class="flex items-center gap-2">
                        <input type="date" id="startDate" class="border rounded-md px-3 py-2 text-sm">
                        <span>to</span>
                        <input type="date" id="endDate" class="border rounded-md px-3 py-2 text-sm">
                    </div>
                </div>
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Filter Tags</label>
                    <select id="tagFilter" multiple placeholder="Select tags to include..."></select>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="excludeBreaks" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="excludeBreaks" class="ml-2 block text-sm text-gray-700">Exclude breaks</label>
                </div>
                <div class="flex items-center">
                    <input type="checkbox" id="roundToHalves" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <label for="roundToHalves" class="ml-2 block text-sm text-gray-700">Round to 0.5h</label>
                </div>
                <button id="generateBtn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-2 rounded-md transition flex items-center h-10 mt-auto">
                    <i class="fas fa-table mr-2"></i> Generate Table
                </button>
            </div>
        </div>

        <!-- Sample Data Toggle -->
        <div class="mb-6 flex justify-center">
            <button id="useSampleBtn" class="text-blue-500 hover:text-blue-700 font-medium flex items-center">
                <i class="fas fa-magic mr-2"></i> Use Sample Data
            </button>
        </div>

        <!-- Stats Summary -->
        <div id="statsContainer" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 fade-in">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-chart-pie mr-2 text-blue-500"></i>
                Summary Statistics
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <p class="text-sm text-blue-600 font-medium">Total Tracked Time</p>
                    <p id="totalTime" class="text-2xl font-bold text-blue-800">0 hours</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <p class="text-sm text-green-600 font-medium">Most Active Tag</p>
                    <p id="topTag" class="text-2xl font-bold text-green-800">-</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <p class="text-sm text-purple-600 font-medium">Average Daily Time</p>
                    <p id="avgDaily" class="text-2xl font-bold text-purple-800">0 hours</p>
                </div>
            </div>
        </div>

        <!-- Main Table -->
        <div id="tableContainer" class="hidden bg-white rounded-lg shadow-md p-6 mb-8 overflow-x-auto scrollbar-hide fade-in">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-table mr-2 text-blue-500"></i>
                Time Allocation by Day and Tag
            </h2>
            <div class="overflow-x-auto">
                <table id="timeTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Notes</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Date</th>
                            <!-- Tags will be inserted here as columns -->
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tag Legend -->
        <div id="legendContainer" class="hidden bg-white rounded-lg shadow-md p-6 fade-in">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-tags mr-2 text-blue-500"></i>
                Tag Legend
            </h2>
            <div id="tagLegend" class="flex flex-wrap gap-2">
                <!-- Tags will be inserted here -->
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const jsonFileInput = document.getElementById('jsonFile');
            const uploadBtn = document.getElementById('uploadBtn');
            const fileName = document.getElementById('fileName');
            const generateBtn = document.getElementById('generateBtn');
            const useSampleBtn = document.getElementById('useSampleBtn');
            const tableContainer = document.getElementById('tableContainer');
            const statsContainer = document.getElementById('statsContainer');
            const legendContainer = document.getElementById('legendContainer');
            const timeTable = document.getElementById('timeTable');
            const tagLegend = document.getElementById('tagLegend');
            const totalTimeEl = document.getElementById('totalTime');
            const topTagEl = document.getElementById('topTag');
            const avgDailyEl = document.getElementById('avgDaily');
            const startDateInput = document.getElementById('startDate');
            const endDateInput = document.getElementById('endDate');
            const excludeBreaksCheckbox = document.getElementById('excludeBreaks');
            const roundToHalvesCheckbox = document.getElementById('roundToHalves');

            // Set default date range (last 7 days)
            const today = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(today.getDate() - 7);
            
            startDateInput.valueAsDate = sevenDaysAgo;
            endDateInput.valueAsDate = today;

            // Initialize tag filter
            const tagFilter = new TomSelect('#tagFilter', {
                plugins: ['remove_button'],
                render: {
                    option: function(data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    },
                    item: function(data, escape) {
                        return `<div>${escape(data.text)}</div>`;
                    }
                }
            });

            // File upload handling
            uploadBtn.addEventListener('click', () => jsonFileInput.click());
            
            jsonFileInput.addEventListener('change', function() {
                if (this.files.length > 0) {
                    fileName.textContent = this.files[0].name;
                } else {
                    fileName.textContent = 'No file selected';
                }
            });

            // Use sample data
            useSampleBtn.addEventListener('click', function() {
                const sampleData = {
                    "sessions": [
                        {
                            "id": 1750080769209,
                            "date": "2025-06-16",
                            "startTime": "2025-06-16T12:15:00.000Z",
                            "endTime": "2025-06-16T13:32:00.000Z",
                            "duration": "01:17:00",
                            "durationSec": 4620,
                            "accumulatedPauseTimeSec": 1920,
                            "notes": "Project meeting",
                            "dayType": "Workday",
                            "tags": ["work", "meeting"],
                            "mood": 5,
                            "isBreak": false
                        },
                        {
                            "id": 1750080766941,
                            "date": "2025-06-16",
                            "startTime": "2025-06-16T13:00:00.000Z",
                            "endTime": "2025-06-16T13:32:00.000Z",
                            "duration": "00:32:00",
                            "durationSec": 1920,
                            "notes": "Break session",
                            "dayType": "Workday",
                            "tags": ["rest", "home tasks"],
                            "mood": 5,
                            "isBreak": true
                        },
                        {
                            "id": 1750080766942,
                            "date": "2025-06-16",
                            "startTime": "2025-06-16T14:00:00.000Z",
                            "endTime": "2025-06-16T16:45:00.000Z",
                            "duration": "02:45:00",
                            "durationSec": 9900,
                            "notes": "Coding session",
                            "dayType": "Workday",
                            "tags": ["work", "coding"],
                            "mood": 4,
                            "isBreak": false
                        },
                        {
                            "id": 1750080766943,
                            "date": "2025-06-17",
                            "startTime": "2025-06-17T09:30:00.000Z",
                            "endTime": "2025-06-17T12:15:00.000Z",
                            "duration": "02:45:00",
                            "durationSec": 9900,
                            "notes": "Morning work session",
                            "dayType": "Workday",
                            "tags": ["work"],
                            "mood": 3,
                            "isBreak": false
                        },
                        {
                            "id": 1750080766944,
                            "date": "2025-06-17",
                            "startTime": "2025-06-17T13:30:00.000Z",
                            "endTime": "2025-06-17T15:00:00.000Z",
                            "duration": "01:30:00",
                            "durationSec": 5400,
                            "notes": "Documentation",
                            "dayType": "Workday",
                            "tags": ["work", "documentation"],
                            "mood": 4,
                            "isBreak": false
                        },
                        {
                            "id": 1750080766945,
                            "date": "2025-06-18",
                            "startTime": "2025-06-18T10:00:00.000Z",
                            "endTime": "2025-06-18T12:00:00.000Z",
                            "duration": "02:00:00",
                            "durationSec": 7200,
                            "notes": "Gym session",
                            "dayType": "Weekend",
                            "tags": ["fitness"],
                            "mood": 5,
                            "isBreak": false
                        },
                        {
                            "id": 1750080766946,
                            "date": "2025-06-18",
                            "startTime": "2025-06-18T14:00:00.000Z",
                            "endTime": "2025-06-18T16:30:00.000Z",
                            "duration": "02:30:00",
                            "durationSec": 9000,
                            "notes": "Reading",
                            "dayType": "Weekend",
                            "tags": ["learning"],
                            "mood": 4,
                            "isBreak": false
                        }
                    ]
                };

                processData(sampleData);
                fileName.textContent = "Using sample data";
            });

            // Generate table from uploaded file
            generateBtn.addEventListener('click', function() {
                if (jsonFileInput.files.length === 0) {
                    alert('Please select a JSON file first or use sample data.');
                    return;
                }

                const file = jsonFileInput.files[0];
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        processData(data);
                    } catch (error) {
                        alert('Error parsing JSON file. Please check the file format.');
                        console.error(error);
                    }
                };

                reader.readAsText(file);
            });

            // Utility function to round to nearest 0.5, with special handling:
            // - >= 0.3 rounds up to 0.5
            // - < 0.3 rounds down to 0.0
            function roundToHalf(num) {
                const decimal = num - Math.floor(num);
                if (decimal >= 0.3 && decimal < 0.8) {
                    return Math.floor(num) + 0.5;
                } else if (decimal >= 0.8) {
                    return Math.ceil(num);
                } else if (decimal >= 0 && decimal < 0.3) {
                    return Math.floor(num);
                }
                return num; // should never reach here for valid numbers
            }

            // Process the data and generate the table
            function processData(data) {
                if (!data || !data.sessions || !Array.isArray(data.sessions)) {
                    alert('Invalid data format. Expected an object with a "sessions" array.');
                    return;
                }

                // Filter sessions by date range
                const startDate = new Date(startDateInput.value);
                const endDate = new Date(endDateInput.value);
                endDate.setHours(23, 59, 59, 999); // Include the entire end date

                const filteredSessions = data.sessions.filter(session => {
                    const sessionDate = new Date(session.date);
                    const dateInRange = sessionDate >= startDate && sessionDate <= endDate;
                    const includeSession = !excludeBreaksCheckbox.checked || !session.isBreak;
                    return dateInRange && includeSession;
                });

                if (filteredSessions.length === 0) {
                    alert('No sessions found in the selected date range.');
                    return;
                }

                // Extract all unique tags from both tags array and notes hashtags
                const allTags = new Set();
                filteredSessions.forEach(session => {
                    // Add regular tags
                    if (session.tags && Array.isArray(session.tags)) {
                        session.tags.forEach(tag => allTags.add(tag));
                    }
                    
                    // Extract hashtags from notes
                    if (session.notes) {
                        const hashtags = session.notes.match(/#\d+/g) || [];
                        hashtags.forEach(tag => allTags.add(tag));
                    }
                });

                // Update tag filter options
                tagFilter.clearOptions();
                tagFilter.addOptions(Array.from(allTags).map(tag => ({value: tag, text: tag})));

                // Get selected tags or use all if none selected
                const selectedTags = tagFilter.items.length > 0 
                    ? tagFilter.items 
                    : Array.from(allTags);
                const uniqueTags = selectedTags.sort();

                // Group sessions by date
                const sessionsByDate = {};
                filteredSessions.forEach(session => {
                    if (!sessionsByDate[session.date]) {
                        sessionsByDate[session.date] = [];
                    }
                    sessionsByDate[session.date].push(session);
                });

                // Calculate time spent per tag per day
                const timeData = {};
                Object.keys(sessionsByDate).forEach(date => {
                    timeData[date] = {};
                    uniqueTags.forEach(tag => {
                        timeData[date][tag] = 0;
                    });

                    sessionsByDate[date].forEach(session => {
                        const durationHours = session.durationSec / 3600;
                        
                        // First try to use hashtags from notes
                        const hashtags = session.notes ? session.notes.match(/#\d+/g) : [];
                        if (hashtags && hashtags.length > 0) {
                            // Use first hashtag if available
                            timeData[date][hashtags[0]] += durationHours;
                            
                            // Subtract this time from the first tag if it exists
                            if (session.tags && session.tags.length > 0) {
                                const primaryTag = session.tags[0];
                                timeData[date][primaryTag] -= durationHours;
                            }
                        } 
                        // Fall back to regular tags if no hashtags
                        else if (session.tags && Array.isArray(session.tags) && session.tags.length > 0) {
                            // Only count time for first tag
                            const primaryTag = session.tags[0];
                            timeData[date][primaryTag] += durationHours;
                        }
                    });
                });

                // Calculate statistics
                let totalHours = 0;
                const tagTotals = {};
                uniqueTags.forEach(tag => {
                    tagTotals[tag] = 0;
                });

                Object.keys(timeData).forEach(date => {
                    uniqueTags.forEach(tag => {
                        tagTotals[tag] += timeData[date][tag];
                        totalHours += timeData[date][tag];
                    });
                });

                const avgDailyHours = totalHours / Object.keys(timeData).length;
                
                // Find top tag
                let topTag = '-';
                let maxHours = 0;
                uniqueTags.forEach(tag => {
                    if (tagTotals[tag] > maxHours) {
                        maxHours = tagTotals[tag];
                        topTag = tag;
                    }
                });

                // Update stats
                totalTimeEl.textContent = `${totalHours.toFixed(1)} hours`;
                topTagEl.textContent = `${topTag} (${maxHours.toFixed(1)}h)`;
                avgDailyEl.textContent = `${avgDailyHours.toFixed(1)} hours`;

                // Generate table header
                const thead = timeTable.querySelector('thead tr');
                thead.innerHTML = `
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Notes</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Total</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">Date</th>
                `;

                uniqueTags.forEach((tag, index) => {
                    const th = document.createElement('th');
                    th.scope = 'col';
                    th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                    th.textContent = tag;
                    thead.appendChild(th);
                });


                // Generate table body
                const tbody = timeTable.querySelector('tbody');
                tbody.innerHTML = '';

                const sortedDates = Object.keys(timeData).sort((a, b) => new Date(a) - new Date(b));

                sortedDates.forEach(date => {
                    const tr = document.createElement('tr');
                    const isWeekend = sessionsByDate[date].some(session => session.dayType === 'Weekend');
                    tr.className = isWeekend ? 'weekend-row hover:bg-amber-100' : 'hover:bg-gray-50';

                    // Notes cell
                    const notesTd = document.createElement('td');
                    notesTd.className = 'px-6 py-4 text-sm text-gray-500 sticky left-0 bg-white max-w-xs break-words whitespace-normal';
                    
                    // Collect notes that match selected tags (or all if no tags selected)
                    const dayNotes = [];
                    sessionsByDate[date].forEach(session => {
                        if (session.notes) {
                            // If tags are selected, check if session has any matching tags
                            const shouldInclude = tagFilter.items.length === 0 || 
                                (session.tags && session.tags.some(tag => tagFilter.items.includes(tag)));
                            
                            if (shouldInclude) {
                                let noteText = session.notes.replace(/#\d+/g, '').trim();
                                if (session.tags && session.tags.length > 1) {
                                    noteText += ` (tags: ${session.tags.join(', ')})`;
                                }
                                if (noteText) {  // Only add if there's text left after removing hashtags
                                    dayNotes.push(noteText);
                                }
                            }
                        }
                    });
                    
                    notesTd.textContent = dayNotes.join(', ');
                    tr.appendChild(notesTd);

                    // Calculate day total first
                    let dayTotal = 0;
                    uniqueTags.forEach(tag => {
                        dayTotal += timeData[date][tag] || 0;
                    });

                    // Total cell
                    const totalTd = document.createElement('td');
                    totalTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 sticky left-0 bg-white';
                    const roundedDayTotal = roundToHalf(dayTotal).toFixed(1);
                    totalTd.textContent = roundToHalvesCheckbox.checked 
                        ? `${roundedDayTotal}h (${dayTotal.toFixed(1)})` 
                        : `${dayTotal.toFixed(1)}h`;
                    tr.appendChild(totalTd);

                    // Date cell
                    const dateTd = document.createElement('td');
                    dateTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white';
                    
                    const dateObj = new Date(date);
                    dateTd.textContent = dateObj.toLocaleDateString('en-US', { 
                        weekday: 'short', 
                        month: 'short', 
                        day: 'numeric' 
                    });
                    
                    tr.appendChild(dateTd);

                    // Tag cells
                    uniqueTags.forEach((tag, index) => {
                        const hours = timeData[date][tag] || 0;
                        const td = document.createElement('td');
                        td.className = `px-6 py-4 whitespace-nowrap text-sm text-gray-500 ${hours > 0 ? 'font-semibold' : ''}`;
                        
                        if (hours > 0) {
                            const hoursFormatted = hours.toFixed(1);
                            const colorClass = `tag-color-${index % 8}`;
                            
                            td.innerHTML = `
                                <div class="flex items-center">
                                    <div class="w-3 h-3 rounded-full ${colorClass} mr-2"></div>
                                    ${roundToHalvesCheckbox.checked ? `${roundToHalf(hours).toFixed(1)}h (${hoursFormatted})` : `${hoursFormatted}h`}
                                </div>
                            `;
                        } else {
                            td.textContent = '-';
                        }
                        
                        tr.appendChild(td);
                    });


                    tbody.appendChild(tr);
                });

                // Add totals row
                const totalsRow = document.createElement('tr');
                totalsRow.className = 'bg-gray-50 font-semibold';

                // Totals label cell
                const notesTotalTd = document.createElement('td');
                notesTotalTd.className = 'px-6 py-4 text-sm text-gray-900 sticky left-0 bg-gray-50';
                notesTotalTd.textContent = 'Totals';
                totalsRow.appendChild(notesTotalTd);

                // Grand total cell (sum of all daily totals)
                let grandTotal = 0;
                sortedDates.forEach(date => {
                    let dayTotal = 0;
                    uniqueTags.forEach(tag => {
                        dayTotal += timeData[date][tag] || 0;
                    });
                    grandTotal += dayTotal;
                });

                const grandTotalTd = document.createElement('td');
                grandTotalTd.className = 'px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900 sticky left-0 bg-gray-50';
                const roundedGrandTotal = roundToHalf(grandTotal).toFixed(1);
                grandTotalTd.textContent = roundToHalvesCheckbox.checked 
                    ? `${roundedGrandTotal}h (${grandTotal.toFixed(1)})` 
                    : `${grandTotal.toFixed(1)}h`;
                totalsRow.appendChild(grandTotalTd);

                // Empty cell for Date (spacer)
                const dateTotalTd = document.createElement('td');
                dateTotalTd.className = 'px-6 py-4 sticky left-0 bg-gray-50';
                totalsRow.appendChild(dateTotalTd);

                // Calculate and add tag totals
                const tagTotalsDisplay = {};
                uniqueTags.forEach(tag => {
                    tagTotalsDisplay[tag] = 0;
                });

                sortedDates.forEach(date => {
                    uniqueTags.forEach(tag => {
                        tagTotalsDisplay[tag] += timeData[date][tag] || 0;
                    });
                });

                uniqueTags.forEach((tag, index) => {
                    const totalHours = tagTotalsDisplay[tag];
                    const td = document.createElement('td');
                    td.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
                    
                    if (totalHours > 0) {
                        const colorClass = `tag-color-${index % 8}`;
                        td.innerHTML = `
                            <div class="flex items-center">
                                <div class="w-3 h-3 rounded-full ${colorClass} mr-2"></div>
                                ${roundToHalvesCheckbox.checked ? `${roundToHalf(totalHours).toFixed(1)}h (${totalHours.toFixed(1)})` : `${totalHours.toFixed(1)}h`}
                            </div>
                        `;
                    } else {
                        td.textContent = '-';
                    }
                    
                    totalsRow.appendChild(td);
                });


                tbody.appendChild(totalsRow);

                // Generate tag legend
                tagLegend.innerHTML = '';
                uniqueTags.forEach((tag, index) => {
                    const colorClass = `tag-color-${index % 8}`;
                    
                    const tagEl = document.createElement('div');
                    tagEl.className = `flex items-center px-3 py-1 rounded-full text-sm ${colorClass}`;
                    tagEl.innerHTML = `
                        <div class="w-3 h-3 rounded-full ${colorClass} mr-2 border border-gray-300"></div>
                        ${tag}
                    `;
                    
                    tagLegend.appendChild(tagEl);
                });

                // Show the containers
                tableContainer.classList.remove('hidden');
                statsContainer.classList.remove('hidden');
                legendContainer.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>